<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Korean for Beginners</title>
<style>
:root {
  --bg: #faf7f2;
  --surface: #fff;
  --surface2: #f0ebe3;
  --border: #e0d8cc;
  --text: #2d2418;
  --dim: #8c7e6a;
  --blue: #4a90d9;
  --green: #3a9d5c;
  --red: #d94452;
  --orange: #e08a3c;
  --yellow: #c9a227;
  --cyan: #2d9ea8;
  --magenta: #9b6ab0;
  --pink: #d4739d;
}

[data-theme="dark"] {
  --bg: #1a1a2e;
  --surface: #16213e;
  --surface2: #1a2745;
  --border: #2a3a5e;
  --text: #e0d8cc;
  --dim: #8899aa;
  --blue: #60a5fa;
  --green: #4ade80;
  --red: #f87171;
  --orange: #fb923c;
  --yellow: #facc15;
  --cyan: #22d3ee;
  --magenta: #c084fc;
  --pink: #f472b6;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}

.container {
  max-width: 680px;
  margin: 0 auto;
  padding: 20px;
}

h1 {
  font-size: 1.8em;
  text-align: center;
  margin-bottom: 4px;
}

h2 {
  font-size: 1.4em;
  margin-bottom: 10px;
}

.subtitle {
  text-align: center;
  color: var(--dim);
  font-size: 0.95em;
  margin-bottom: 15px;
}

/* Menu */
.menu { display: flex; flex-direction: column; gap: 8px; margin: 15px 0; }
.menu button {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  border-radius: 12px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 1em;
  transition: all 0.15s;
  text-align: left;
}
.menu button:hover { background: var(--surface2); border-color: var(--blue); }
.menu .num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  border-radius: 8px;
  background: var(--surface2);
  color: var(--blue);
  font-weight: bold;
  font-size: 0.85em;
  flex-shrink: 0;
}

.stats-bar {
  text-align: center;
  color: var(--dim);
  font-size: 0.85em;
  margin: 6px 0;
}
.stats-bar span { color: var(--text); font-weight: bold; }

/* Card */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 30px;
  margin: 15px 0;
  text-align: center;
}

.card-korean {
  font-size: 2.2em;
  font-weight: bold;
  color: var(--text);
  margin-bottom: 8px;
}

.card-english {
  font-size: 1.8em;
  font-weight: bold;
  color: var(--text);
  margin-bottom: 8px;
}

.card-prompt {
  color: var(--dim);
  margin: 15px 0 20px;
  font-size: 0.95em;
}

/* TTS button */
.tts-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 1px solid var(--border);
  background: var(--surface2);
  cursor: pointer;
  font-size: 1.2em;
  transition: all 0.15s;
  vertical-align: middle;
  margin-left: 8px;
}
.tts-btn:hover { background: var(--blue); color: #fff; border-color: var(--blue); }

/* Answer area */
.answer-input {
  width: 100%;
  padding: 14px 18px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 1.05em;
  outline: none;
  transition: border-color 0.15s;
}
.answer-input:focus { border-color: var(--blue); }
.answer-input::placeholder { color: var(--dim); }

/* Reveal */
.reveal {
  background: var(--surface);
  border: 1px solid var(--blue);
  border-radius: 12px;
  padding: 20px 25px;
  margin: 15px 0;
}

.reveal-answer {
  font-size: 1.2em;
  font-weight: bold;
  color: var(--text);
  margin-bottom: 6px;
}

.reveal-notes {
  color: var(--dim);
  font-size: 0.9em;
  line-height: 1.5;
}

.example {
  margin: 12px 0;
  padding-left: 12px;
  border-left: 3px solid var(--yellow);
}

.example-kr {
  color: var(--text);
  font-size: 1em;
  font-weight: 500;
}

.example-en {
  color: var(--dim);
  font-size: 0.9em;
  margin-top: 2px;
}

/* Result */
.result-correct { border-color: var(--green); }
.result-correct .reveal-answer::before { content: 'Correct! '; color: var(--green); }
.result-incorrect { border-color: var(--red); }
.result-incorrect .reveal-answer::before { content: 'Incorrect — '; color: var(--red); }

/* Rating buttons */
.rating {
  display: flex;
  gap: 10px;
  margin: 20px 0;
  flex-wrap: wrap;
}

.rating button {
  flex: 1;
  min-width: 70px;
  padding: 12px 8px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  transition: all 0.15s;
  font-size: 0.95em;
}

.rating button:hover { transform: translateY(-1px); }
.rating button:active { transform: translateY(0); }

.rating .btn-again { border-color: var(--red); }
.rating .btn-again:hover { background: rgba(217,68,82,0.1); }
.rating .btn-again .label { color: var(--red); font-weight: bold; }

.rating .btn-hard { border-color: var(--orange); }
.rating .btn-hard:hover { background: rgba(224,138,60,0.1); }
.rating .btn-hard .label { color: var(--orange); font-weight: bold; }

.rating .btn-good { border-color: var(--green); }
.rating .btn-good:hover { background: rgba(58,157,92,0.1); }
.rating .btn-good .label { color: var(--green); font-weight: bold; }

.rating .btn-easy { border-color: var(--cyan); }
.rating .btn-easy:hover { background: rgba(45,158,168,0.1); }
.rating .btn-easy .label { color: var(--cyan); font-weight: bold; }

.rating .desc { color: var(--dim); font-size: 0.75em; }

/* Progress bar */
.progress-bar {
  height: 4px;
  background: var(--surface2);
  border-radius: 2px;
  margin: 15px 0;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: var(--blue);
  border-radius: 2px;
  transition: width 0.3s;
}

/* Option grid */
.option-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin: 15px 0;
}

.option-btn {
  padding: 14px 16px;
  border-radius: 10px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 1.05em;
  transition: all 0.15s;
  text-align: center;
}

.option-btn:hover { background: var(--surface2); border-color: var(--blue); }
.option-btn.correct { border-color: var(--green); background: rgba(58,157,92,0.1); color: var(--green); font-weight: bold; }
.option-btn.wrong { border-color: var(--red); background: rgba(217,68,82,0.08); color: var(--red); }

/* Cloze */
.cloze-sentence {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 25px;
  margin: 15px 0;
  line-height: 1.8;
  font-size: 1.15em;
  color: var(--text);
  text-align: center;
}
.cloze-blank {
  display: inline-block;
  min-width: 80px;
  border-bottom: 2px solid var(--cyan);
  color: var(--cyan);
  font-weight: bold;
  text-align: center;
  padding: 0 8px;
}

/* Grammar drill */
.fill-prompt {
  color: var(--cyan);
  font-weight: bold;
  margin: 15px 0 8px;
}

.fill-sentence {
  color: var(--text);
  margin-bottom: 12px;
  font-size: 1.1em;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px 25px;
  line-height: 1.8;
  text-align: center;
}

.fill-sentence .blank {
  display: inline-block;
  min-width: 80px;
  border-bottom: 2px solid var(--cyan);
  color: var(--cyan);
  font-weight: bold;
  text-align: center;
  padding: 0 8px;
}

/* Summary */
.summary {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 25px;
  text-align: center;
  margin: 20px 0;
}
.summary h2 { margin-bottom: 15px; color: var(--blue); }

.summary-stats {
  display: flex;
  justify-content: center;
  gap: 30px;
  margin: 15px 0;
  flex-wrap: wrap;
}

.summary-stat { text-align: center; }
.summary-stat .value { font-size: 1.8em; font-weight: bold; }
.summary-stat .label { color: var(--dim); font-size: 0.85em; }
.comment { color: var(--dim); font-style: italic; margin-top: 10px; }

/* Progress table */
.progress-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
.progress-table th, .progress-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
.progress-table th { color: var(--cyan); font-size: 0.85em; text-transform: uppercase; }

/* Buttons */
.btn {
  padding: 12px 24px;
  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--text);
  cursor: pointer;
  font-size: 1em;
  transition: all 0.15s;
}
.btn:hover { background: var(--surface2); border-color: var(--blue); }
.btn-primary { background: var(--blue); border-color: var(--blue); color: #fff; font-weight: bold; }
.btn-primary:hover { opacity: 0.9; }

.back-btn {
  background: none;
  border: none;
  color: var(--dim);
  cursor: pointer;
  font-size: 0.9em;
  padding: 8px 0;
  margin-bottom: 10px;
}
.back-btn:hover { color: var(--text); }

.counter {
  color: var(--dim);
  font-size: 0.85em;
  text-align: right;
  margin-bottom: 10px;
}

.your-guess {
  color: var(--dim);
  font-size: 0.95em;
  margin: 10px 0;
  padding: 10px 14px;
  background: var(--surface2);
  border-radius: 8px;
}
.your-guess span { color: var(--text); font-weight: bold; }

.hidden { display: none; }

.shortcuts {
  color: var(--dim);
  font-size: 0.8em;
  text-align: center;
  margin: 5px 0;
}

/* Timer */
.timer-bar {
  height: 4px;
  background: var(--surface2);
  border-radius: 2px;
  margin-bottom: 8px;
  overflow: hidden;
}
.timer-fill { height: 100%; border-radius: 2px; transition: width 0.1s linear; }
.timer-label { text-align: right; font-size: 0.8em; color: var(--dim); margin-bottom: 4px; }

/* Timed toggle */
.timed-toggle {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  margin: 8px 0;
  font-size: 0.85em;
  color: var(--dim);
  cursor: pointer;
}
.timed-toggle .switch {
  width: 36px; height: 20px; background: var(--surface2);
  border-radius: 10px; position: relative; transition: background 0.2s;
}
.timed-toggle .switch::after {
  content: ''; position: absolute; width: 16px; height: 16px;
  background: var(--dim); border-radius: 50%; top: 2px; left: 2px; transition: all 0.2s;
}
.timed-toggle.active .switch { background: var(--blue); }
.timed-toggle.active .switch::after { left: 18px; background: #fff; }

/* Settings row */
.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid var(--border);
}
.settings-row:last-child { border-bottom: none; }
.settings-label { color: var(--text); font-size: 0.95em; }
.settings-desc { color: var(--dim); font-size: 0.8em; margin-top: 2px; }

/* Sync */
.sync-status { text-align: center; font-size: 0.8em; color: var(--dim); margin-bottom: 5px; }
.sync-status.synced { color: var(--green); }
.sync-status.syncing { color: var(--yellow); }
.sync-status.offline { color: var(--dim); }

.offline-banner {
  background: rgba(224,138,60,0.12);
  color: var(--orange);
  text-align: center;
  padding: 8px;
  font-size: 0.85em;
  border-radius: 8px;
  margin-bottom: 10px;
  display: none;
}
.offline-banner.visible { display: block; }

/* Listening drill */
.listen-prompt {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 30px;
  margin: 15px 0;
  text-align: center;
}
.listen-big-btn {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 2px solid var(--blue);
  background: var(--surface2);
  cursor: pointer;
  font-size: 2em;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  color: var(--blue);
}
.listen-big-btn:hover { background: var(--blue); color: #fff; }
.listen-hint { color: var(--dim); font-size: 0.9em; margin-top: 12px; }

/* Category badges */
.cat-badge {
  display: inline-block;
  background: var(--surface2);
  color: var(--dim);
  padding: 3px 10px;
  border-radius: 10px;
  font-size: 0.75em;
  margin-bottom: 8px;
}

/* Category progress in select screen */
.cat-progress-wrap {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-width: 0;
}
.cat-progress-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 6px;
}
.cat-progress-bar {
  flex: 1;
  height: 4px;
  background: var(--surface2);
  border-radius: 2px;
  overflow: hidden;
}
.cat-progress-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.3s;
}
.cat-progress-label {
  color: var(--dim);
  font-size: 0.7em;
  white-space: nowrap;
}

/* Streak */
.streak-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: rgba(224,138,60,0.12);
  color: var(--orange);
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.85em;
  font-weight: bold;
}

@media (max-width: 600px) {
  .container { padding: 12px; }
  .card-korean { font-size: 1.7em; }
  .card-english { font-size: 1.3em; }
  .rating button { min-width: 60px; padding: 10px 4px; }
  h1 { font-size: 1.5em; }
  .summary-stats { gap: 15px; }
  .option-grid { grid-template-columns: 1fr 1fr; }
}

@media (max-width: 380px) {
  .option-grid { grid-template-columns: 1fr; }
  .rating { flex-wrap: wrap; }
}
</style>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
</head>
<body>

<div class="container" id="app">
  <!-- Populated by JS -->
</div>

<script>
// ===== SRS ENGINE (SM-2) =====
const AGAIN = 0, HARD = 2, GOOD = 3, EASY = 5;

class Card {
  constructor(data = {}) {
    this.card_id = data.card_id || '';
    this.ease_factor = data.ease_factor || 2.5;
    this.interval_days = data.interval_days || 0;
    this.repetitions = data.repetitions || 0;
    this.next_review = data.next_review || 0;
    this.last_review = data.last_review || 0;
    this.total_reviews = data.total_reviews || 0;
    this.correct_count = data.correct_count || 0;
  }

  get accuracy() {
    return this.total_reviews === 0 ? 0 : this.correct_count / this.total_reviews;
  }

  review(quality) {
    const now = Date.now() / 1000;
    this.last_review = now;
    this.total_reviews++;
    if (quality >= GOOD) this.correct_count++;

    if (quality < GOOD) {
      this.repetitions = 0;
      this.interval_days = 0.007;
    } else {
      if (this.repetitions === 0) this.interval_days = 0.04;
      else if (this.repetitions === 1) this.interval_days = 1;
      else if (this.repetitions === 2) this.interval_days = 3;
      else this.interval_days *= this.ease_factor;
      this.repetitions++;
    }

    this.ease_factor += 0.1 - (5 - quality) * (0.08 + (5 - quality) * 0.02);
    this.ease_factor = Math.max(1.3, this.ease_factor);
    this.next_review = now + this.interval_days * 86400;
  }
}

class SRSEngine {
  constructor() {
    this.cards = {};
    this._load();
  }

  _load() {
    try {
      const data = JSON.parse(localStorage.getItem('beginner_korean_srs') || '{}');
      for (const [id, d] of Object.entries(data)) this.cards[id] = new Card(d);
    } catch(e) {}
  }

  save() {
    localStorage.setItem('beginner_korean_srs', JSON.stringify(this.cards));
    pushToFirestore();
  }

  getCard(id) {
    if (!this.cards[id]) this.cards[id] = new Card({card_id: id});
    return this.cards[id];
  }

  getDueCards(ids) {
    const now = Date.now() / 1000;
    const due = [], newCards = [];
    for (const id of ids) {
      if (!this.cards[id]) newCards.push(id);
      else if (this.cards[id].next_review <= now) due.push(id);
    }
    due.sort((a, b) => this.cards[a].next_review - this.cards[b].next_review);
    return [...due, ...newCards];
  }

  recordReview(id, quality) {
    this.getCard(id).review(quality);
    this.save();
  }

  getStats() {
    const now = Date.now() / 1000;
    const cards = Object.values(this.cards);
    const total = cards.length;
    if (total === 0) return {total: 0, due: 0, learning: 0, mature: 0, accuracy: 0};
    return {
      total,
      due: cards.filter(c => c.next_review <= now).length,
      learning: cards.filter(c => c.interval_days < 7).length,
      mature: cards.filter(c => c.interval_days >= 7).length,
      accuracy: cards.reduce((s,c) => s + c.correct_count, 0) / Math.max(1, cards.reduce((s,c) => s + c.total_reviews, 0))
    };
  }
}

// ===== FIREBASE SYNC =====
// Replace with your own Firebase config to enable sync
const FIREBASE_CONFIG = {
  apiKey: "",
  authDomain: "",
  projectId: "",
  storageBucket: "",
  messagingSenderId: "",
  appId: ""
};

let db = null, userId = null, syncEnabled = false;

async function initFirebase() {
  if (!FIREBASE_CONFIG.apiKey) return;
  try {
    firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.firestore();
    const auth = firebase.auth();
    const cred = await auth.signInAnonymously();
    userId = cred.user.uid;
    localStorage.setItem('beginner_korean_uid', userId);
    syncEnabled = true;
    updateSyncStatus('synced', 'Synced');
    await pullFromFirestore();
  } catch(e) {
    console.warn('Firebase init failed, using local only:', e);
    updateSyncStatus('offline', 'Local only');
  }
}

async function pushToFirestore() {
  if (!syncEnabled || !db || !userId) return;
  try {
    updateSyncStatus('syncing', 'Syncing...');
    const data = JSON.parse(localStorage.getItem('beginner_korean_srs') || '{}');
    await db.collection('beginner_users').doc(userId).set({
      srs: JSON.stringify(data),
      updated: firebase.firestore.FieldValue.serverTimestamp()
    });
    updateSyncStatus('synced', 'Synced');
  } catch(e) {
    console.warn('Firestore push failed:', e);
    updateSyncStatus('offline', 'Sync failed');
  }
}

async function pullFromFirestore() {
  if (!syncEnabled || !db || !userId) return;
  try {
    const doc = await db.collection('beginner_users').doc(userId).get();
    if (doc.exists && doc.data().srs) {
      const remote = JSON.parse(doc.data().srs);
      const local = JSON.parse(localStorage.getItem('beginner_korean_srs') || '{}');
      const merged = {...local};
      for (const [id, rCard] of Object.entries(remote)) {
        if (!merged[id] || (rCard.last_review || 0) > (merged[id].last_review || 0)) {
          merged[id] = rCard;
        }
      }
      localStorage.setItem('beginner_korean_srs', JSON.stringify(merged));
      srs._load();
    }
  } catch(e) {
    console.warn('Firestore pull failed:', e);
  }
}

function updateSyncStatus(cls, text) {
  const el = document.getElementById('sync-status');
  if (el) { el.className = 'sync-status ' + cls; el.textContent = text; }
}

// ===== TTS =====
function speak(text) {
  if (!('speechSynthesis' in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'ko-KR';
  u.rate = 0.85;
  // Try to find a Korean voice
  const voices = speechSynthesis.getVoices();
  const koVoice = voices.find(v => v.lang.startsWith('ko'));
  if (koVoice) u.voice = koVoice;
  speechSynthesis.speak(u);
}

function ttsBtn(text) {
  return `<button class="tts-btn" onclick="event.stopPropagation();speak('${text.replace(/'/g, "\\'")}')">&#128264;</button>`;
}

// ===== APP STATE =====
const app = document.getElementById('app');
const srs = new SRSEngine();
let vocabData = {}, grammarData = {};
let timedMode = localStorage.getItem('beginner_korean_timed') === 'true';
let activeTimer = null;
let darkMode = localStorage.getItem('beginner_korean_dark') === 'true';

if (darkMode) document.documentElement.setAttribute('data-theme', 'dark');

// Ensure TTS voices are loaded
if ('speechSynthesis' in window) {
  speechSynthesis.getVoices();
  speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
}

// ===== STREAK TRACKING =====
function getStreak() {
  const data = JSON.parse(localStorage.getItem('beginner_korean_streak') || '{"count":0,"lastDate":""}');
  const today = new Date().toISOString().slice(0, 10);
  if (data.lastDate === today) return data.count;
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  if (data.lastDate === yesterday) return data.count;
  return 0;
}

function recordStudyDay() {
  const data = JSON.parse(localStorage.getItem('beginner_korean_streak') || '{"count":0,"lastDate":""}');
  const today = new Date().toISOString().slice(0, 10);
  if (data.lastDate === today) return;
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  if (data.lastDate === yesterday) {
    data.count++;
  } else {
    data.count = 1;
  }
  data.lastDate = today;
  localStorage.setItem('beginner_korean_streak', JSON.stringify(data));
}

// ===== TIMER =====
function toggleTimedMode() {
  timedMode = !timedMode;
  localStorage.setItem('beginner_korean_timed', timedMode);
  showMenu();
}

function startTimer(seconds, onExpire) {
  clearTimer();
  const start = Date.now();
  const ms = seconds * 1000;
  const fill = document.getElementById('timer-fill');
  const label = document.getElementById('timer-label');
  if (!fill) return;
  activeTimer = setInterval(() => {
    const elapsed = Date.now() - start;
    const pct = Math.max(0, 100 - (elapsed / ms * 100));
    const remaining = Math.max(0, Math.ceil((ms - elapsed) / 1000));
    fill.style.width = pct + '%';
    fill.style.background = pct > 30 ? 'var(--blue)' : pct > 10 ? 'var(--orange)' : 'var(--red)';
    if (label) label.textContent = remaining + 's';
    if (elapsed >= ms) { clearTimer(); if (label) label.textContent = '0s'; onExpire(); }
  }, 100);
}

function clearTimer() {
  if (activeTimer) { clearInterval(activeTimer); activeTimer = null; }
}

function timerHtml(seconds) {
  if (!timedMode) return '';
  return `<div class="timer-label" id="timer-label">${seconds}s</div>
    <div class="timer-bar"><div class="timer-fill" id="timer-fill" style="width:100%;background:var(--blue)"></div></div>`;
}

// ===== UTILITIES =====
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function escHtml(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function countTotal() {
  let v = 0, g = 0;
  for (const entries of Object.values(vocabData)) v += entries.length;
  for (const entries of Object.values(grammarData)) g += entries.length;
  return {vocab: v, grammar: g, total: v + g, cats: Object.keys(vocabData).length + Object.keys(grammarData).length};
}

// ===== MAIN MENU =====
function showMenu() {
  const stats = srs.getStats();
  const totals = countTotal();
  const streak = getStreak();
  const reviewedPct = totals.total > 0 ? Math.round(stats.total / totals.total * 100) : 0;

  const streakHtml = streak > 0 ? `<div style="text-align:center;margin:8px 0"><span class="streak-badge">${streak} day${streak > 1 ? 's' : ''} streak</span></div>` : '';

  const statsHtml = `
    <div class="stats-bar">
      <span>${totals.vocab.toLocaleString()}</span> vocab &nbsp;|&nbsp;
      <span>${totals.grammar}</span> grammar &nbsp;|&nbsp;
      <span>${totals.cats}</span> categories
    </div>
    ${stats.total > 0 ? `<div class="stats-bar">
      Reviewed: <span>${stats.total}/${totals.total}</span> (${reviewedPct}%) &nbsp;|&nbsp;
      Due: <span>${stats.due}</span> &nbsp;|&nbsp;
      Accuracy: <span>${Math.round(stats.accuracy * 100)}%</span>
    </div>` : ''}`;

  const syncHtml = syncEnabled ? '<div id="sync-status" class="sync-status synced">Synced</div>'
    : FIREBASE_CONFIG.apiKey ? '<div id="sync-status" class="sync-status offline">Connecting...</div>'
    : '';

  app.innerHTML = `
    <h1>한국어 첫걸음</h1>
    <p class="subtitle">Korean for Beginners</p>
    <div id="offline-banner" class="offline-banner${isOffline ? ' visible' : ''}">${isOffline ? 'Offline — using cached data' : ''}</div>
    ${syncHtml}
    ${streakHtml}
    ${statsHtml}
    <div class="menu">
      <button onclick="showCategorySelect('vocab')"><span class="num">1</span> Vocabulary Drill</button>
      <button onclick="startMultipleChoice()"><span class="num">2</span> Multiple Choice Quiz</button>
      <button onclick="showCategorySelect('grammar')"><span class="num">3</span> Grammar Practice</button>
      <button onclick="startListeningDrill()"><span class="num">4</span> Listening Drill</button>
      <button onclick="startMixedReview()"><span class="num">5</span> Mixed Review (weakest first)</button>
      <button onclick="startClozeDrill()"><span class="num">6</span> Cloze Drill (fill the gap)</button>
      <button onclick="showProgress()"><span class="num">7</span> View Progress</button>
    </div>
    <div class="timed-toggle${timedMode ? ' active' : ''}" onclick="toggleTimedMode()">
      <div class="switch"></div> Timed Mode ${timedMode ? 'ON' : 'OFF'}
    </div>
    <div style="text-align:center;margin-top:8px">
      <button class="back-btn" onclick="toggleDarkMode()" style="margin:0">${darkMode ? 'Light Mode' : 'Dark Mode'}</button>
    </div>
    <div class="shortcuts">Keyboard: 1-7 to select &nbsp;|&nbsp; T for timer</div>`;

  document.onkeydown = e => {
    if (e.key === '1') showCategorySelect('vocab');
    else if (e.key === '2') startMultipleChoice();
    else if (e.key === '3') showCategorySelect('grammar');
    else if (e.key === '4') startListeningDrill();
    else if (e.key === '5') startMixedReview();
    else if (e.key === '6') startClozeDrill();
    else if (e.key === '7') showProgress();
    else if (e.key === 't') toggleTimedMode();
  };
}

function toggleDarkMode() {
  darkMode = !darkMode;
  localStorage.setItem('beginner_korean_dark', darkMode);
  document.documentElement.setAttribute('data-theme', darkMode ? 'dark' : '');
  showMenu();
}

// ===== CATEGORY SELECT =====
function getCatProgress(type, cat, entries) {
  const ids = entries.map((_, i) => `${type}:${cat}:${i}`);
  const reviewed = ids.filter(id => srs.cards[id]).length;
  const total = entries.length;
  const pct = total > 0 ? Math.round(reviewed / total * 100) : 0;
  const color = pct === 0 ? 'var(--dim)' : pct < 30 ? 'var(--red)' : pct < 70 ? 'var(--orange)' : pct < 100 ? 'var(--blue)' : 'var(--green)';
  return {reviewed, total, pct, color};
}

function showCategorySelect(type) {
  const data = type === 'vocab' ? vocabData : grammarData;
  const cats = Object.keys(data);
  const title = type === 'vocab' ? 'Vocabulary Drill' : 'Grammar Practice';

  // Overall progress for "All Categories"
  let allReviewed = 0, allTotal = 0;
  for (const c of cats) { const p = getCatProgress(type, c, data[c]); allReviewed += p.reviewed; allTotal += p.total; }
  const allPct = allTotal > 0 ? Math.round(allReviewed / allTotal * 100) : 0;
  const allColor = allPct === 0 ? 'var(--dim)' : allPct < 30 ? 'var(--red)' : allPct < 70 ? 'var(--orange)' : allPct < 100 ? 'var(--blue)' : 'var(--green)';

  app.innerHTML = `
    <button class="back-btn" onclick="showMenu()">&#8592; Back</button>
    <h2 style="margin-bottom:15px">${title}</h2>
    <div class="menu">
      <button onclick="startDrill('${type}', null)"><span class="num">0</span>
        <div class="cat-progress-wrap">All Categories
          <div class="cat-progress-row">
            <div class="cat-progress-bar"><div class="cat-progress-fill" style="width:${allPct}%;background:${allColor}"></div></div>
            <span class="cat-progress-label">${allReviewed}/${allTotal}</span>
          </div>
        </div>
      </button>
      ${cats.map((c, i) => {
        const p = getCatProgress(type, c, data[c]);
        return `<button onclick="startDrill('${type}', '${escHtml(c)}')"><span class="num">${i+1}</span>
          <div class="cat-progress-wrap">${escHtml(c)}
            <div class="cat-progress-row">
              <div class="cat-progress-bar"><div class="cat-progress-fill" style="width:${p.pct}%;background:${p.color}"></div></div>
              <span class="cat-progress-label">${p.reviewed}/${p.total}</span>
            </div>
          </div>
        </button>`;
      }).join('')}
    </div>`;
  document.onkeydown = e => { if (e.key === 'Escape') showMenu(); };
}

// ===== POOL BUILDING =====
function buildPool(type, category) {
  const data = type === 'vocab' ? vocabData : grammarData;
  const cats = category ? [category] : Object.keys(data);
  const pool = [];
  for (const cat of cats) {
    if (!data[cat]) continue;
    for (let i = 0; i < data[cat].length; i++) {
      pool.push({id: `${type}:${cat}:${i}`, type, cat, entry: data[cat][i]});
    }
  }
  return pool;
}

function prioritizeCards(pool, limit) {
  const ids = pool.map(p => p.id);
  const dueSet = new Set(srs.getDueCards(ids));
  const due = shuffle(pool.filter(p => dueSet.has(p.id))).slice(0, limit);
  if (due.length < limit) {
    const rest = shuffle(pool.filter(p => !dueSet.has(p.id)));
    due.push(...rest.slice(0, limit - due.length));
  }
  return due;
}

// ===== VOCAB FLASHCARD DRILL =====
function startDrill(type, category) {
  const pool = buildPool(type, category);
  const session = prioritizeCards(pool, 12);
  if (session.length === 0) { showMenu(); return; }
  if (type === 'grammar') { runGrammarSession(session); return; }
  runVocabSession(session);
}

function runVocabSession(cards) {
  let idx = 0, correct = 0, reviewed = 0;

  function showCard() {
    if (idx >= cards.length) { showSummary(reviewed, correct); return; }
    const {id, type, cat, entry} = cards[idx];
    const progress = `${idx + 1}/${cards.length}`;
    const pct = ((idx) / cards.length * 100).toFixed(0);
    const showKorean = Math.random() < 0.5;

    const prompt = showKorean
      ? `<div class="card">
           <div class="card-korean">${escHtml(entry.korean)} ${ttsBtn(entry.korean)}</div>
         </div><div class="card-prompt">What does this mean?</div>`
      : `<div class="card"><div class="card-english">${escHtml(entry.english).replace(/\n/g,'<br>')}</div>
         </div><div class="card-prompt">What is this in Korean?</div>`;

    const answer = showKorean ? entry.english : entry.korean;

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter"><span class="cat-badge">${escHtml(cat)}</span> &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${timerHtml(15)}
      ${prompt}
      <input class="answer-input" placeholder="Your answer (Enter to reveal)" autofocus>`;

    const input = app.querySelector('.answer-input');
    input.focus();
    if (timedMode) startTimer(15, () => revealVocab(id, cat, entry, answer, input.value.trim(), progress, pct));
    input.onkeydown = e => {
      if (e.key === 'Enter') { clearTimer(); revealVocab(id, cat, entry, answer, input.value.trim(), progress, pct); }
      if (e.key === 'Escape') { clearTimer(); showMenu(); }
    };
  }

  function revealVocab(id, cat, entry, answer, guess, progress, pct) {
    let extra = '';
    if (entry.notes) extra += `<div class="reveal-notes">${escHtml(entry.notes)}</div>`;
    if (entry.example) extra += `<div class="example"><div class="example-kr">${escHtml(entry.example)} ${ttsBtn(entry.example)}</div>
      ${entry.example_en ? `<div class="example-en">${escHtml(entry.example_en)}</div>` : ''}</div>`;

    const guessHtml = guess ? `<div class="your-guess">Your answer: <span>${escHtml(guess)}</span></div>` : '';

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter"><span class="cat-badge">${escHtml(cat)}</span> &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${guessHtml}
      <div class="reveal"><div class="reveal-answer">${escHtml(answer)} ${answer === entry.korean ? ttsBtn(entry.korean) : ttsBtn(entry.korean)}</div>${extra}</div>
      ${ratingButtons()}`;
    setupRating(id);
  }

  function ratingButtons() {
    return `
      <div class="rating">
        <button class="btn-again" data-q="${AGAIN}"><div class="label">Again</div><div class="desc">didn't know</div></button>
        <button class="btn-hard" data-q="${HARD}"><div class="label">Hard</div><div class="desc">struggled</div></button>
        <button class="btn-good" data-q="${GOOD}"><div class="label">Good</div><div class="desc">knew it</div></button>
        <button class="btn-easy" data-q="${EASY}"><div class="label">Easy</div><div class="desc">effortless</div></button>
      </div>
      <div class="shortcuts">1=Again  2=Hard  3=Good  4=Easy</div>`;
  }

  function setupRating(id) {
    document.querySelectorAll('.rating button').forEach(btn => {
      btn.onclick = () => rate(id, parseInt(btn.dataset.q));
    });
    document.onkeydown = e => {
      const map = {'1': AGAIN, '2': HARD, '3': GOOD, '4': EASY};
      if (map[e.key] !== undefined) rate(id, map[e.key]);
      if (e.key === 'Escape') showMenu();
    };
  }

  function rate(id, quality) {
    recordStudyDay();
    srs.recordReview(id, quality);
    reviewed++;
    if (quality >= GOOD) correct++;
    idx++;
    showCard();
  }

  showCard();
}

// ===== GRAMMAR DRILL =====
function runGrammarSession(cards) {
  let idx = 0, correct = 0, reviewed = 0;

  function showCard() {
    if (idx >= cards.length) { showSummary(reviewed, correct); return; }
    const {id, type, cat, entry} = cards[idx];
    const progress = `${idx + 1}/${cards.length}`;
    const pct = ((idx) / cards.length * 100).toFixed(0);

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter"><span class="cat-badge">${escHtml(cat)}</span> &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${timerHtml(20)}
      <div class="card"><div class="card-korean">${escHtml(entry.pattern)}</div></div>
      <div class="card-prompt">What does this pattern mean?</div>
      <input class="answer-input" placeholder="Your answer (Enter to reveal)" autofocus>`;

    const input = app.querySelector('.answer-input');
    input.focus();
    if (timedMode) startTimer(20, () => revealGrammar(id, cat, entry, input.value.trim(), progress, pct));
    input.onkeydown = e => {
      if (e.key === 'Enter') { clearTimer(); revealGrammar(id, cat, entry, input.value.trim(), progress, pct); }
      if (e.key === 'Escape') { clearTimer(); showMenu(); }
    };
  }

  function revealGrammar(id, cat, entry, guess, progress, pct) {
    let examplesHtml = '';
    for (const ex of (entry.examples || [])) {
      examplesHtml += `<div class="example"><div class="example-kr">${escHtml(ex.korean)} ${ttsBtn(ex.korean)}</div>
        ${ex.english ? `<div class="example-en">${escHtml(ex.english)}</div>` : ''}</div>`;
    }

    let drillHtml = '';
    if (entry.drill && entry.drill.options) {
      const sentenceHtml = escHtml(entry.drill.prompt).replace('_____', '<span class="blank">?</span>');
      drillHtml = `
        <div class="fill-prompt">Fill in the blank:</div>
        <div class="fill-sentence">${sentenceHtml}</div>
        <div class="option-grid" id="grammar-options">
          ${entry.drill.options.map((opt, i) => `<button class="option-btn" data-idx="${i}">${escHtml(opt)}</button>`).join('')}
        </div>
        <div id="drill-result" class="hidden"></div>`;
    } else if (entry.drill) {
      drillHtml = `
        <div class="fill-prompt">Fill in the blank:</div>
        <div class="fill-sentence">${escHtml(entry.drill.prompt)}</div>
        <input class="answer-input" id="drill-input" placeholder="Your answer" autofocus>
        <div id="drill-result" class="hidden"></div>`;
    }

    const guessHtml = guess ? `<div class="your-guess">Your answer: <span>${escHtml(guess)}</span></div>` : '';

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter"><span class="cat-badge">${escHtml(cat)}</span> &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${((idx)/cards.length*100).toFixed(0)}%"></div></div>
      ${guessHtml}
      <div class="reveal">
        <div class="reveal-answer">${escHtml(entry.meaning)}</div>
        <div class="reveal-notes">${escHtml(entry.explanation)}</div>
      </div>
      ${examplesHtml}
      ${drillHtml}
      ${entry.drill ? '' : ratingButtons()}`;

    if (entry.drill && entry.drill.options) {
      document.querySelectorAll('#grammar-options .option-btn').forEach(btn => {
        btn.onclick = () => {
          const chosen = parseInt(btn.dataset.idx);
          const correctIdx = entry.drill.options.indexOf(entry.drill.answer);
          const isCorrect = entry.drill.options[chosen] === entry.drill.answer;

          document.querySelectorAll('#grammar-options .option-btn').forEach((b, i) => {
            b.disabled = true;
            if (entry.drill.options[i] === entry.drill.answer) b.classList.add('correct');
            else if (i === chosen && !isCorrect) b.classList.add('wrong');
          });

          const fullSentence = entry.drill.full_sentence || '';
          document.getElementById('drill-result').innerHTML = `
            <div class="reveal ${isCorrect ? 'result-correct' : 'result-incorrect'}" style="margin-top:12px">
              <div class="reveal-answer">${escHtml(entry.drill.answer)}</div>
            </div>
            ${fullSentence ? `<div class="example"><div class="example-kr">${escHtml(fullSentence)} ${ttsBtn(fullSentence)}</div>
              ${entry.drill.full_sentence_en ? `<div class="example-en">${escHtml(entry.drill.full_sentence_en)}</div>` : ''}</div>` : ''}
            ${ratingButtons()}`;
          document.getElementById('drill-result').classList.remove('hidden');
          setupRating(id);
        };
      });
    } else if (entry.drill) {
      const di = document.getElementById('drill-input');
      if (di) {
        di.focus();
        di.onkeydown = e => {
          if (e.key === 'Enter') {
            const isCorrect = di.value.trim() === entry.drill.answer;
            document.getElementById('drill-result').innerHTML = `
              <div class="reveal ${isCorrect ? 'result-correct' : 'result-incorrect'}" style="margin-top:12px">
                <div class="reveal-answer">${escHtml(entry.drill.answer)}</div>
              </div>
              ${entry.drill.full_sentence ? `<div class="example"><div class="example-kr">${escHtml(entry.drill.full_sentence)} ${ttsBtn(entry.drill.full_sentence)}</div></div>` : ''}
              ${ratingButtons()}`;
            document.getElementById('drill-result').classList.remove('hidden');
            di.disabled = true;
            setupRating(id);
          }
          if (e.key === 'Escape') showMenu();
        };
      }
    } else {
      setupRating(id);
    }
  }

  function ratingButtons() {
    return `
      <div class="rating">
        <button class="btn-again" data-q="${AGAIN}"><div class="label">Again</div><div class="desc">didn't know</div></button>
        <button class="btn-hard" data-q="${HARD}"><div class="label">Hard</div><div class="desc">struggled</div></button>
        <button class="btn-good" data-q="${GOOD}"><div class="label">Good</div><div class="desc">knew it</div></button>
        <button class="btn-easy" data-q="${EASY}"><div class="label">Easy</div><div class="desc">effortless</div></button>
      </div>
      <div class="shortcuts">1=Again  2=Hard  3=Good  4=Easy</div>`;
  }

  function setupRating(id) {
    document.querySelectorAll('.rating button').forEach(btn => {
      btn.onclick = () => rate(id, parseInt(btn.dataset.q));
    });
    document.onkeydown = e => {
      const map = {'1': AGAIN, '2': HARD, '3': GOOD, '4': EASY};
      if (map[e.key] !== undefined) rate(id, map[e.key]);
      if (e.key === 'Escape') showMenu();
    };
  }

  function rate(id, quality) {
    recordStudyDay();
    srs.recordReview(id, quality);
    reviewed++;
    if (quality >= GOOD) correct++;
    idx++;
    showCard();
  }

  showCard();
}

// ===== MULTIPLE CHOICE QUIZ =====
function startMultipleChoice() {
  const pool = buildPool('vocab', null);
  const session = prioritizeCards(pool, 12);
  if (session.length === 0) { showMenu(); return; }

  let idx = 0, correct = 0, reviewed = 0;

  function showCard() {
    if (idx >= session.length) { showSummary(reviewed, correct); return; }
    const {id, cat, entry} = session[idx];
    const progress = `${idx + 1}/${session.length}`;
    const pct = ((idx) / session.length * 100).toFixed(0);

    // Get 3 distractors from vocab
    const distractors = getDistractors(entry, cat, 'english');
    const options = shuffle([entry.english, ...distractors]);

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter">Multiple Choice &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${timerHtml(12)}
      <div class="card">
        <div class="card-korean">${escHtml(entry.korean)} ${ttsBtn(entry.korean)}</div>
      </div>
      <div class="card-prompt">Choose the correct meaning:</div>
      <div class="option-grid">
        ${options.map((opt, i) => `<button class="option-btn" data-idx="${i}" data-val="${escHtml(opt)}">${escHtml(opt)}</button>`).join('')}
      </div>`;

    if (timedMode) startTimer(12, () => revealMC(id, entry, -1, options, progress, pct));
    document.querySelectorAll('.option-btn').forEach(btn => {
      btn.onclick = () => { clearTimer(); revealMC(id, entry, parseInt(btn.dataset.idx), options, progress, pct); };
    });
    document.onkeydown = e => {
      const num = parseInt(e.key);
      if (num >= 1 && num <= 4) { clearTimer(); revealMC(id, entry, num - 1, options, progress, pct); }
      if (e.key === 'Escape') { clearTimer(); showMenu(); }
    };
  }

  function revealMC(id, entry, chosenIdx, options, progress, pct) {
    const chosen = chosenIdx >= 0 ? options[chosenIdx] : '';
    const isCorrect = chosen === entry.english;

    const optionsHtml = options.map((opt, i) => {
      let cls = '';
      if (opt === entry.english) cls = 'correct';
      else if (i === chosenIdx && !isCorrect) cls = 'wrong';
      return `<button class="option-btn ${cls}" disabled>${escHtml(opt)}</button>`;
    }).join('');

    let extra = '';
    if (entry.notes) extra += `<div class="reveal-notes">${escHtml(entry.notes)}</div>`;
    if (entry.example) extra += `<div class="example"><div class="example-kr">${escHtml(entry.example)} ${ttsBtn(entry.example)}</div>
      ${entry.example_en ? `<div class="example-en">${escHtml(entry.example_en)}</div>` : ''}</div>`;

    const quality = isCorrect ? GOOD : AGAIN;
    recordStudyDay();
    srs.recordReview(id, quality);
    reviewed++;
    if (isCorrect) correct++;

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter">Multiple Choice &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="card">
        <div class="card-korean">${escHtml(entry.korean)} ${ttsBtn(entry.korean)}</div>
      </div>
      <div class="option-grid">${optionsHtml}</div>
      <div class="reveal ${isCorrect ? 'result-correct' : 'result-incorrect'}">
        <div class="reveal-answer">${escHtml(entry.english)}</div>
        ${extra}
      </div>
      <button class="btn btn-primary" id="next-btn" style="width:100%;margin-top:15px">Next &#8594;</button>`;

    document.getElementById('next-btn').onclick = () => { idx++; showCard(); };
    document.onkeydown = e => {
      if (e.key === 'Enter' || e.key === ' ') { idx++; showCard(); }
      if (e.key === 'Escape') showMenu();
    };
  }

  showCard();
}

// ===== LISTENING DRILL =====
function startListeningDrill() {
  const pool = buildPool('vocab', null);
  const session = prioritizeCards(pool, 10);
  if (session.length === 0) { showMenu(); return; }

  let idx = 0, correct = 0, reviewed = 0;

  function showCard() {
    if (idx >= session.length) { showSummary(reviewed, correct); return; }
    const {id, cat, entry} = session[idx];
    const progress = `${idx + 1}/${session.length}`;
    const pct = ((idx) / session.length * 100).toFixed(0);

    const distractors = getDistractors(entry, cat, 'english');
    const options = shuffle([entry.english, ...distractors]);

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter">Listening Drill &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${timerHtml(15)}
      <div class="listen-prompt">
        <button class="listen-big-btn" onclick="speak('${entry.korean.replace(/'/g, "\\'")}')">&#128264;</button>
        <div class="listen-hint">Tap to listen again</div>
      </div>
      <div class="card-prompt">What did you hear?</div>
      <div class="option-grid">
        ${options.map((opt, i) => `<button class="option-btn" data-idx="${i}" data-val="${escHtml(opt)}">${escHtml(opt)}</button>`).join('')}
      </div>`;

    // Auto-play the word
    setTimeout(() => speak(entry.korean), 300);

    if (timedMode) startTimer(15, () => revealListening(id, entry, -1, options, progress, pct));
    document.querySelectorAll('.option-btn').forEach(btn => {
      btn.onclick = () => { clearTimer(); revealListening(id, entry, parseInt(btn.dataset.idx), options, progress, pct); };
    });
    document.onkeydown = e => {
      const num = parseInt(e.key);
      if (num >= 1 && num <= 4) { clearTimer(); revealListening(id, entry, num - 1, options, progress, pct); }
      if (e.key === 'r') speak(entry.korean);
      if (e.key === 'Escape') { clearTimer(); showMenu(); }
    };
  }

  function revealListening(id, entry, chosenIdx, options, progress, pct) {
    const chosen = chosenIdx >= 0 ? options[chosenIdx] : '';
    const isCorrect = chosen === entry.english;

    const optionsHtml = options.map((opt, i) => {
      let cls = '';
      if (opt === entry.english) cls = 'correct';
      else if (i === chosenIdx && !isCorrect) cls = 'wrong';
      return `<button class="option-btn ${cls}" disabled>${escHtml(opt)}</button>`;
    }).join('');

    const quality = isCorrect ? GOOD : AGAIN;
    recordStudyDay();
    srs.recordReview(id, quality);
    reviewed++;
    if (isCorrect) correct++;

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter">Listening Drill &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="card">
        <div class="card-korean">${escHtml(entry.korean)} ${ttsBtn(entry.korean)}</div>
      </div>
      <div class="option-grid">${optionsHtml}</div>
      <div class="reveal ${isCorrect ? 'result-correct' : 'result-incorrect'}">
        <div class="reveal-answer">${escHtml(entry.english)}</div>
        ${entry.notes ? `<div class="reveal-notes">${escHtml(entry.notes)}</div>` : ''}
      </div>
      <button class="btn btn-primary" id="next-btn" style="width:100%;margin-top:15px">Next &#8594;</button>`;

    document.getElementById('next-btn').onclick = () => { idx++; showCard(); };
    document.onkeydown = e => {
      if (e.key === 'Enter' || e.key === ' ') { idx++; showCard(); }
      if (e.key === 'Escape') showMenu();
    };
  }

  showCard();
}

// ===== MIXED REVIEW =====
function startMixedReview() {
  const vPool = buildPool('vocab', null);
  const gPool = buildPool('grammar', null);
  const pool = [...vPool, ...gPool];
  const session = prioritizeCards(pool, 15);
  if (session.length === 0) { showMenu(); return; }

  // Split by type and run appropriate session
  const vocabCards = session.filter(c => c.type === 'vocab');
  const grammarCards = session.filter(c => c.type === 'grammar');

  // Interleave them in a single session
  runMixedSession(session);
}

function runMixedSession(cards) {
  let idx = 0, correct = 0, reviewed = 0;

  function showCard() {
    if (idx >= cards.length) { showSummary(reviewed, correct); return; }
    const card = cards[idx];
    if (card.type === 'grammar') {
      showGrammarMixed(card);
    } else {
      showVocabMixed(card);
    }
  }

  function showVocabMixed(card) {
    const {id, cat, entry} = card;
    const progress = `${idx + 1}/${cards.length}`;
    const pct = ((idx) / cards.length * 100).toFixed(0);
    const showKorean = Math.random() < 0.5;
    const prompt = showKorean
      ? `<div class="card"><div class="card-korean">${escHtml(entry.korean)} ${ttsBtn(entry.korean)}</div></div><div class="card-prompt">What does this mean?</div>`
      : `<div class="card"><div class="card-english">${escHtml(entry.english).replace(/\n/g,'<br>')}</div></div><div class="card-prompt">What is this in Korean?</div>`;
    const answer = showKorean ? entry.english : entry.korean;

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter"><span class="cat-badge">${escHtml(cat)}</span> &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${prompt}
      <input class="answer-input" placeholder="Your answer (Enter to reveal)" autofocus>`;

    const input = app.querySelector('.answer-input');
    input.focus();
    input.onkeydown = e => {
      if (e.key === 'Enter') revealMixed(id, entry, answer, input.value.trim(), progress, pct);
      if (e.key === 'Escape') showMenu();
    };
  }

  function showGrammarMixed(card) {
    const {id, cat, entry} = card;
    const progress = `${idx + 1}/${cards.length}`;
    const pct = ((idx) / cards.length * 100).toFixed(0);

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter"><span class="cat-badge">${escHtml(cat)}</span> &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="card"><div class="card-korean">${escHtml(entry.pattern)}</div></div>
      <div class="card-prompt">What does this pattern mean?</div>
      <input class="answer-input" placeholder="Your answer (Enter to reveal)" autofocus>`;

    const input = app.querySelector('.answer-input');
    input.focus();
    input.onkeydown = e => {
      if (e.key === 'Enter') revealMixed(id, entry, entry.meaning, input.value.trim(), progress, pct);
      if (e.key === 'Escape') showMenu();
    };
  }

  function revealMixed(id, entry, answer, guess, progress, pct) {
    const guessHtml = guess ? `<div class="your-guess">Your answer: <span>${escHtml(guess)}</span></div>` : '';
    let extra = '';
    if (entry.notes) extra += `<div class="reveal-notes">${escHtml(entry.notes)}</div>`;
    if (entry.example) extra += `<div class="example"><div class="example-kr">${escHtml(entry.example)} ${ttsBtn(entry.example)}</div>
      ${entry.example_en ? `<div class="example-en">${escHtml(entry.example_en)}</div>` : ''}</div>`;
    if (entry.examples) {
      for (const ex of entry.examples) {
        extra += `<div class="example"><div class="example-kr">${escHtml(ex.korean)} ${ttsBtn(ex.korean)}</div>
          ${ex.english ? `<div class="example-en">${escHtml(ex.english)}</div>` : ''}</div>`;
      }
    }

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter">Mixed Review &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${guessHtml}
      <div class="reveal"><div class="reveal-answer">${escHtml(answer)}</div>${extra}</div>
      <div class="rating">
        <button class="btn-again" data-q="${AGAIN}"><div class="label">Again</div><div class="desc">didn't know</div></button>
        <button class="btn-hard" data-q="${HARD}"><div class="label">Hard</div><div class="desc">struggled</div></button>
        <button class="btn-good" data-q="${GOOD}"><div class="label">Good</div><div class="desc">knew it</div></button>
        <button class="btn-easy" data-q="${EASY}"><div class="label">Easy</div><div class="desc">effortless</div></button>
      </div>
      <div class="shortcuts">1=Again  2=Hard  3=Good  4=Easy</div>`;

    document.querySelectorAll('.rating button').forEach(btn => {
      btn.onclick = () => {
        const q = parseInt(btn.dataset.q);
        recordStudyDay();
        srs.recordReview(id, q);
        reviewed++;
        if (q >= GOOD) correct++;
        idx++;
        showCard();
      };
    });
    document.onkeydown = e => {
      const map = {'1': AGAIN, '2': HARD, '3': GOOD, '4': EASY};
      if (map[e.key] !== undefined) {
        const q = map[e.key];
        recordStudyDay();
        srs.recordReview(id, q);
        reviewed++;
        if (q >= GOOD) correct++;
        idx++;
        showCard();
      }
      if (e.key === 'Escape') showMenu();
    };
  }

  showCard();
}

// ===== CLOZE DRILL =====
function startClozeDrill() {
  const pool = [];
  for (const [cat, entries] of Object.entries(vocabData)) {
    for (let i = 0; i < entries.length; i++) {
      const e = entries[i];
      if (e.example && e.korean && e.example.includes(e.korean)) {
        pool.push({id: `cloze:${cat}:${i}`, cat, entry: e});
      }
    }
  }
  if (pool.length === 0) { showMenu(); return; }

  const ids = pool.map(p => p.id);
  const dueSet = new Set(srs.getDueCards(ids));
  let session = shuffle(pool.filter(p => dueSet.has(p.id))).slice(0, 12);
  if (session.length < 12) {
    const rest = shuffle(pool.filter(p => !dueSet.has(p.id)));
    session.push(...rest.slice(0, 12 - session.length));
  }

  let idx = 0, correct = 0, reviewed = 0;

  function showCard() {
    if (idx >= session.length) { showSummary(reviewed, correct); return; }
    const {id, cat, entry} = session[idx];
    const progress = `${idx + 1}/${session.length}`;
    const pct = ((idx) / session.length * 100).toFixed(0);

    const sentenceHtml = escHtml(entry.example).replace(escHtml(entry.korean), '<span class="cloze-blank">?</span>');
    const distractors = getDistractors(entry, cat, 'korean');
    const options = shuffle([entry.korean, ...distractors]);

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter">Cloze Drill &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      ${timerHtml(12)}
      <div class="cloze-sentence">${sentenceHtml}</div>
      <div class="card-prompt">Fill in the blank:</div>
      <div class="option-grid">
        ${options.map((opt, i) => `<button class="option-btn" data-idx="${i}" data-val="${escHtml(opt)}">${escHtml(opt)}</button>`).join('')}
      </div>
      ${entry.example_en ? `<div style="color:var(--dim);font-size:0.85em;text-align:center;margin-top:8px">${escHtml(entry.example_en)}</div>` : ''}`;

    if (timedMode) startTimer(12, () => revealCloze(id, entry, -1, options, progress, pct));
    document.querySelectorAll('.option-btn').forEach(btn => {
      btn.onclick = () => { clearTimer(); revealCloze(id, entry, parseInt(btn.dataset.idx), options, progress, pct); };
    });
    document.onkeydown = e => {
      const num = parseInt(e.key);
      if (num >= 1 && num <= 4) { clearTimer(); revealCloze(id, entry, num - 1, options, progress, pct); }
      if (e.key === 'Escape') { clearTimer(); showMenu(); }
    };
  }

  function revealCloze(id, entry, chosenIdx, options, progress, pct) {
    const chosen = chosenIdx >= 0 ? options[chosenIdx] : '';
    const isCorrect = chosen === entry.korean;
    const sentenceHtml = escHtml(entry.example).replace(escHtml(entry.korean),
      `<span class="cloze-blank" style="border-color:var(--green);color:var(--green)">${escHtml(entry.korean)}</span>`);

    const optionsHtml = options.map((opt, i) => {
      let cls = '';
      if (opt === entry.korean) cls = 'correct';
      else if (i === chosenIdx && !isCorrect) cls = 'wrong';
      return `<button class="option-btn ${cls}" disabled>${escHtml(opt)}</button>`;
    }).join('');

    const quality = isCorrect ? GOOD : AGAIN;
    recordStudyDay();
    srs.recordReview(id, quality);
    reviewed++;
    if (isCorrect) correct++;

    app.innerHTML = `
      <button class="back-btn" onclick="showMenu()">&#8592; Quit</button>
      <div class="counter">Cloze Drill &nbsp; ${progress}</div>
      <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
      <div class="cloze-sentence">${sentenceHtml}</div>
      <div class="option-grid">${optionsHtml}</div>
      <div class="reveal ${isCorrect ? 'result-correct' : 'result-incorrect'}">
        <div class="reveal-answer">${escHtml(entry.korean)} — ${escHtml(entry.english)}</div>
        ${entry.notes ? `<div class="reveal-notes">${escHtml(entry.notes)}</div>` : ''}
      </div>
      <button class="btn btn-primary" id="next-btn" style="width:100%;margin-top:15px">Next &#8594;</button>`;

    document.getElementById('next-btn').onclick = () => { idx++; showCard(); };
    document.onkeydown = e => {
      if (e.key === 'Enter' || e.key === ' ') { idx++; showCard(); }
      if (e.key === 'Escape') showMenu();
    };
  }

  showCard();
}

// ===== DISTRACTOR HELPER =====
function getDistractors(entry, cat, field) {
  const candidates = [];
  const sameCat = vocabData[cat] || [];
  for (const e of sameCat) {
    if (e[field] !== entry[field] && e[field] && e[field].length > 1) {
      candidates.push(e[field]);
    }
  }
  if (candidates.length < 3) {
    for (const [c, entries] of Object.entries(vocabData)) {
      if (c === cat) continue;
      for (const e of entries) {
        if (e[field] !== entry[field] && e[field] && e[field].length > 1) {
          candidates.push(e[field]);
        }
      }
      if (candidates.length >= 20) break;
    }
  }
  // Deduplicate
  const unique = [...new Set(candidates)];
  return shuffle(unique).slice(0, 3);
}

// ===== SUMMARY =====
function showSummary(reviewed, correct) {
  const acc = reviewed > 0 ? correct / reviewed : 0;
  let comment, color;
  if (acc >= 0.9) { comment = 'Amazing work!'; color = 'var(--green)'; }
  else if (acc >= 0.7) { comment = 'Great job! Keep it up!'; color = 'var(--blue)'; }
  else if (acc >= 0.5) { comment = 'Getting there! Practice makes perfect.'; color = 'var(--orange)'; }
  else { comment = "Don't worry, these will come back for more practice!"; color = 'var(--red)'; }

  app.innerHTML = `
    <div class="summary">
      <h2>Session Complete</h2>
      <div class="summary-stats">
        <div class="summary-stat"><div class="value">${reviewed}</div><div class="label">Reviewed</div></div>
        <div class="summary-stat"><div class="value">${correct}</div><div class="label">Correct</div></div>
        <div class="summary-stat"><div class="value" style="color:${color}">${Math.round(acc*100)}%</div><div class="label">Accuracy</div></div>
      </div>
      <div class="comment">${comment}</div>
    </div>
    <button class="btn btn-primary" onclick="showMenu()" style="width:100%">Back to Menu</button>`;
  document.onkeydown = e => { if (e.key === 'Enter' || e.key === 'Escape') showMenu(); };
}

// ===== PROGRESS VIEW =====
function showProgress() {
  const stats = srs.getStats();
  const totals = countTotal();
  const cards = Object.values(srs.cards);
  const weak = [...cards].sort((a,b) => a.ease_factor - b.ease_factor).slice(0, 15);
  const streak = getStreak();

  let weakRows = '';
  for (const c of weak) {
    const parts = c.card_id.split(':');
    let label = c.card_id;
    try {
      const type = parts[0], cat = parts[1], pidx = parseInt(parts[2]);
      const data = type === 'vocab' || type === 'cloze' ? vocabData : grammarData;
      if (data[cat] && data[cat][pidx]) {
        label = type === 'vocab' || type === 'cloze' ? data[cat][pidx].korean : data[cat][pidx].pattern;
      }
    } catch(e) {}
    weakRows += `<tr><td>${escHtml(label)}</td><td>${Math.round(c.accuracy*100)}%</td><td>${c.total_reviews}</td><td>${c.ease_factor.toFixed(1)}</td></tr>`;
  }

  // Category breakdown
  let catBreakdown = '';
  for (const [cat, entries] of Object.entries(vocabData)) {
    const catIds = entries.map((_, i) => `vocab:${cat}:${i}`);
    const reviewed = catIds.filter(id => srs.cards[id]).length;
    const pct = entries.length > 0 ? Math.round(reviewed / entries.length * 100) : 0;
    catBreakdown += `<tr><td>${escHtml(cat)}</td><td>${reviewed}/${entries.length}</td><td>${pct}%</td></tr>`;
  }

  app.innerHTML = `
    <button class="back-btn" onclick="showMenu()">&#8592; Back</button>
    <h2 style="margin-bottom:20px">Progress</h2>
    ${streak > 0 ? `<div style="text-align:center;margin-bottom:15px"><span class="streak-badge">${streak} day${streak > 1 ? 's' : ''} streak</span></div>` : ''}
    <div class="summary-stats" style="margin-bottom:25px">
      <div class="summary-stat"><div class="value" style="color:var(--cyan)">${stats.total}</div><div class="label">Cards Seen</div></div>
      <div class="summary-stat"><div class="value" style="color:var(--orange)">${stats.due}</div><div class="label">Due Now</div></div>
      <div class="summary-stat"><div class="value" style="color:var(--green)">${stats.mature}</div><div class="label">Mature</div></div>
      <div class="summary-stat"><div class="value" style="color:var(--blue)">${Math.round(stats.accuracy*100)}%</div><div class="label">Accuracy</div></div>
    </div>
    ${weak.length > 0 ? `
      <h3 style="margin-bottom:10px;color:var(--dim)">Weakest Cards</h3>
      <table class="progress-table">
        <tr><th>Card</th><th>Acc</th><th>Reviews</th><th>Ease</th></tr>
        ${weakRows}
      </table>` : '<p style="color:var(--dim)">No cards reviewed yet. Start a drill!</p>'}
    ${catBreakdown ? `
      <h3 style="margin:20px 0 10px;color:var(--dim)">Categories</h3>
      <table class="progress-table">
        <tr><th>Category</th><th>Reviewed</th><th>%</th></tr>
        ${catBreakdown}
      </table>` : ''}
    <button class="btn" onclick="if(confirm('Reset all progress? This cannot be undone.')){localStorage.removeItem('beginner_korean_srs');localStorage.removeItem('beginner_korean_streak');location.reload()}" style="margin-top:20px;color:var(--red);border-color:var(--red)">Reset Progress</button>`;
  document.onkeydown = e => { if (e.key === 'Escape') showMenu(); };
}

// ===== LOAD DATA =====
async function init() {
  app.innerHTML = '<h1>&#54620;&#44397;&#50612; &#52395;&#44152;&#51020;</h1><p class="subtitle">Loading...</p>';
  try {
    const [vResp, gResp] = await Promise.all([
      fetch('data/vocab.json'),
      fetch('data/grammar.json')
    ]);
    vocabData = await vResp.json();
    grammarData = await gResp.json();
  } catch(e) {
    try {
      const [vResp, gResp] = await Promise.all([
        fetch('../data/vocab.json'),
        fetch('../data/grammar.json')
      ]);
      vocabData = await vResp.json();
      grammarData = await gResp.json();
    } catch(e2) {
      app.innerHTML = '<h1>Error</h1><p>Could not load data files.</p>';
      return;
    }
  }
  await initFirebase();
  showMenu();
}

// ===== OFFLINE MODE =====
let isOffline = !navigator.onLine;

function updateOfflineBanner() {
  const banner = document.getElementById('offline-banner');
  if (banner) {
    banner.classList.toggle('visible', isOffline);
    banner.textContent = isOffline ? 'Offline — using cached data' : '';
  }
}

window.addEventListener('online', () => { isOffline = false; updateOfflineBanner(); updateSyncStatus('synced', 'Back online'); pushToFirestore(); });
window.addEventListener('offline', () => { isOffline = true; updateOfflineBanner(); updateSyncStatus('offline', 'Offline'); });

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

init();
</script>
</body>
</html>
